---
title: "Model Optimization"
output: html_document
---

# Researching the best OTUs for improved predictions
First I was curious what a random forest model would look like trained on the delay data. Mostly I was interested in the OTUs determined by randomforest's feature selection algorithm that overlapped with the current working 5 OTU model.


``` {r, eval=TRUE}
#################################
###rf of the delay data
delay<-read.csv("~/Desktop/mothur/abxD01/rf/abxD01.final.an.unique_list.0.03.subsample.0.03.pick.shared.rf.delay.regression.logtrans.filter16mintot.csv", header=T)
delay<-delay[,-1]

library(randomForest)

#fit the randomforest model
delay_model <- randomForest(nextDayCFU~., 
                               data = delay,  outscale=TRUE,
                               importance=TRUE, proximity=TRUE,
                               keep.forest=TRUE, ntree=5000
)
plot(delay_model)

print(delay_model)


#what are the important variables (via permutation) #type 1 is mean decrease in accuracy, type 2 is mean decrease in node impurity
varImpPlot(delay_model, type=1)
imp<-importance(delay_model)
most.imp<-rownames(imp[order(imp[, "%IncMSE"], decreasing=T)[1:17],])
```

5000 trees looks apropriate (flatlined) when looking at the plot(delay_model) graph. The % Var explained was 74.31. Not too shabby! (Just as a note, I'm reporting the original results I got, so the numbers will be slightly different, as well as some differences in the importance plot.)

The OTUs that overlapped included 6 and 39, which were in the 5 OTU model. OTU11 has most influence, followed by 1, 5, 23, 21, 3, 6, 39 before dropping off in %IncMSE.  I'm curious to see what inclusion of OTU11 (Ecoli) will have on the effect of the model. I like the idea of including that because it's the most positively correlated OTU with *C. difficile* CFU the next day.


The next thing I was interested in was seeing which OTUs rf identified when building a model based on the titration and original data sets:

``` {r, eval=TRUE}
#################################
###rf of titration + topdose data
toptit<-read.csv("~/Desktop/mothur/abxD01/rf/abxD01.final.an.unique_list.0.03.subsample.0.03.pick.shared.rf.toptit.regression.logtrans.filter16mintot.csv", header=T)
toptit<-toptit[,-1]

library(randomForest)

#fit the randomforest model
toptit_model <- randomForest(nextDayCFU~., 
                            data = toptit,  outscale=TRUE,
                            importance=TRUE, proximity=TRUE,
                            keep.forest=TRUE, ntree=5000
)
plot(toptit_model)

print(toptit_model)


#what are the important variables (via permutation) #type 1 is mean decrease in accuracy, type 2 is mean decrease in node impurity
varImpPlot(toptit_model, type=1)
imp<-importance(toptit_model)
most.imp<-rownames(imp[order(imp[, "%IncMSE"], decreasing=T)[1:17],])

```

% Var explained goes up to 90%! The OTUs, or really the ONE OTU that far and away was important was OTU3, followed by 13, and 27. 


# Revising and Expanding on the 5 OTU model

Testing the inclusion of either OTU 11 or OTU 3 or both and how it affects the other 5 OTUs.
```{r, eval=TRUE}
###Reperform the model building forcing certain OTUs to be present, such as OTU11 and OTU3. 

library(leaps)

topdose<-read.csv("~/Desktop/mothur/abxD01/model/abxD01.final.an.unique_list.0.03.subsample.filter16mintotal.shared.topdose2.logtrans.19otus.rfnegpos.csv", header=T)
td<-topdose[,-1]
attach(td)
ids<-names(td)
ids = ids[-1]

#this will make 30 models--the 3 best for each model with 1 to 10 variables
leap11<-regsubsets(nextDayCFU ~ Otu00002 + Otu00003 + Otu00006 + Otu00007 + Otu00011 + Otu00013 + Otu00015 + Otu00019 + Otu00020 + Otu00023 + Otu00027 + Otu00029 + Otu00039 + Otu00044 + Otu00065 + Otu00078 + Otu00120 + Otu00283 + Otu00431, data=td, nbest=3, nvmax=10, force.in=c(5)) #the force.in parameter takes 2=OTU3, 5=OTU11
#shows the best models and which variables to include
summary(leap11)
#shows the value for each parameter in the model along with intercept
vcov(leap11, 50) ##the second parameter corresponds to model number, so 50 is the max/last model
#coef
coef(leap11, 1:2)
#scales=bic, Cp, and adjr2, r2
plot(leap11,scale="adjr2")
plot(leap11,scale="bic")
```

After looking at the results I don't think it affects the other 5 OTUs in the model at all. Though I haven't tested for improved predictions yet! 

I next want to read in a topdose/titration combo file and see how the top linear models change or not for the combined data. Do the 5 OTUs stay the same in terms of importance?

```{r, eval=TRUE}
###read in 
toptit<-read.csv("~/Desktop/mothur/abxD01/model/abxD01.final.an.unique_list.0.03.subsample.filter16mintotal.shared.toptit.logtrans.19otus.rfnegpos.csv", header=T)
tt<-toptit[,-1]
attach(tt)
ids<-names(tt)
ids = ids[-1]

#this will make 30 models--the 3 best for each model with 1 to 10 variables
leap11<-regsubsets(nextDayCFU ~ Otu00002 + Otu00003 + Otu00006 + Otu00007 + Otu00011 + Otu00013 + Otu00015 + Otu00019 + Otu00020 + Otu00023 + Otu00027 + Otu00029 + Otu00039 + Otu00044 + Otu00065 + Otu00078 + Otu00120 + Otu00283 + Otu00431, data=tt, nbest=3, nvmax=10, force.in=NULL) #the force.in parameter takes 2=OTU3, 5=OTU11
#shows the best models and which variables to include
summary(leap11)
#shows the value for each parameter in the model along with intercept
vcov(leap11, 50) ##the second parameter corresponds to model number, so 50 is the max/last model
#coef
coef(leap11, 1:2)
#scales=bic, Cp, and adjr2, r2
plot(leap11,scale="adjr2")
plot(leap11,scale="bic")
```

